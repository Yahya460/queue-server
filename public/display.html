<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شاشة العرض — نظام الدور</title>
<style>
  :root{
    --sky:#d6ecff; --bar:#0f77ff; --yellow:#facc15; --text:#001;
    --panel:#fff; --accent:#1d4ed8;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Segoe UI", Arial, sans-serif;
    background:var(--sky); color:var(--text);
  }
  .container{
    display:grid; grid-template-columns: 1fr minmax(580px,2fr) 1fr;
    gap:12px; min-height:100vh;
  }
  .panel{
    background:#fff; border:1px solid #ccd; display:flex; flex-direction:column;
  }
  .bar{ background:var(--bar); color:#fff; padding:10px 14px; font-weight:800; }
  .list{ flex:1; overflow:auto; padding:10px; }
  .list ul{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px;}
  .list li{ font-weight:800; font-size:28px; padding:6px 10px; border-bottom:1px dashed #ddd;}
  .center{
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    padding:16px; gap:24px; background:#eaf3ff; border-left:4px solid var(--bar); border-right:4px solid var(--bar);
  }
  .logo{ width:120px; margin:8px auto 0; }
  .big{
    width:100%; background:#fff; border:2px solid #e1e5ee; padding:22px 12px; display:flex; flex-direction:column; align-items:center;
  }
  .big .go{ font-size:20px; margin-bottom:8px; font-weight:700;}
  .big .num{ font-size:86px; font-weight:900; color:#b91c1c; line-height:1;}
  .big .committee{ font-size:26px; margin-top:6px; font-weight:700;}
  .bottom{
    background:#fff6db; padding:8px 12px; border-top:2px solid #ffd97c; width:100%; text-align:center; font-weight:700;
  }
  .status{position:fixed; left:12px; bottom:10px; padding:6px 10px; background:#00000080; color:#fff; border-radius:6px; font-size:13px}
  .ticker{ white-space:nowrap; overflow:hidden; }
  .ticker span{ display:inline-block; padding-left:60px; animation:mar 16s linear infinite; }
  @keyframes mar{ from{transform:translateX(100%)} to{transform:translateX(-100%)} }
  .abs{ font-size:16px; padding:6px; }
  .abs b{ color:#b91c1c; }
  .note{ font-weight:800; color:#1f2937; }
  .head{
    position:sticky; top:0; background:#0d47a1; color:#fff; text-align:center; padding:8px; font-weight:800;
  }
  .foot{
    text-align:center; padding:10px; color:#1e293b; font-weight:700; border-top:1px solid #cfd8e3; background:#eef5ff;
  }
</style>
</head>
<body>

<div class="head">شاشة العرض (PLUS) — يُرجى تفعيل الصوت بنقرة واحدة داخل الصفحة</div>

<div class="container">

  <!-- يسار: تم النداء — رجال -->
  <div class="panel">
    <div class="bar">MEN / رجال — تم النداء</div>
    <div class="list"><ul id="list-men"></ul></div>
  </div>

  <!-- وسط -->
  <div class="panel">
    <div class="center">
      <img class="logo" src="/logo.png" onerror="this.style.display='none'">
      <div class="big">
        <div class="go">يرجى التوجه لمنطقة الاختبار — Please proceed to the examination area</div>
        <div class="num" id="big-num">—</div>
        <div class="committee" id="big-committee">اللجنة —</div>
      </div>
      <div class="bottom">
        <div class="abs"><b>الغياب رجال:</b> <span id="abs-men"></span></div>
        <div class="abs"><b>الغياب نساء:</b> <span id="abs-women"></span></div>
        <div class="ticker"><span class="note" id="note-text"></span></div>
      </div>
    </div>
    <div class="foot">معهد السلامة المرورية بصحار — جميع الحقوق محفوظة للرقيب أول يحيى آل عبدالسلام 2025</div>
  </div>

  <!-- يمين: تم النداء — نساء -->
  <div class="panel">
    <div class="bar" style="background:var(--yellow); color:#111">WOMEN / نساء — تم النداء</div>
    <div class="list"><ul id="list-women"></ul></div>
  </div>

</div>

<div class="status" id="status">جاري الاتصال…</div>

<!-- أصوات (ضع ملفاتك إن وجدت) -->
<audio id="audMen" preload="auto"></audio>
<audio id="audWomen" preload="auto"></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  const socket = io();

  const st  = document.getElementById('status');
  const men = document.getElementById('list-men');
  const wom = document.getElementById('list-women');
  const bigN= document.getElementById('big-num');
  const bigC= document.getElementById('big-committee');
  const absM= document.getElementById('abs-men');
  const absW= document.getElementById('abs-women');
  const note= document.getElementById('note-text');

  const audMen = document.getElementById('audMen');
  const audWom = document.getElementById('audWomen');

  // يمكن ضبط مسارات الصوت هنا إن كانت لديك ملفات
  // audMen.src = '/sounds/men.mp3';
  // audWom.src = '/sounds/women.mp3';

  let soundUnlocked = false;
  function unlockSound(){
    if(soundUnlocked) return;
    [audMen, audWom].forEach(a=>{
      try{ a.play().then(()=>{ a.pause(); a.currentTime=0; soundUnlocked=true; })
           .catch(()=>{}); }catch(_){}
    });
  }
  document.addEventListener('click', unlockSound, {once:true, capture:true});
  document.addEventListener('touchstart', unlockSound, {once:true, capture:true});

  function showStatus(t){ st.textContent = t; }

  socket.on('connect', ()=> showStatus('متصل بالخادم'));
  socket.on('disconnect', ()=> showStatus('انقطع الاتصال — سيُعاد المحاولة'));
  socket.on('connect_error', ()=> showStatus('فشل الاتصال — تأكد من الإنترنت'));

  function normGender(g){
    g = (g||'').toString().toUpperCase();
    if(g.includes('WOM') || g.includes('نس')) return 'WOMEN';
    return 'MEN';
  }
  function pushItem(ul, text){
    if(!ul) return;
    const li = document.createElement('li');
    li.textContent = text;
    ul.prepend(li);
    while(ul.children.length > 12) ul.lastChild.remove();
  }
  function showCenter(student, committee){
    bigN.textContent = student ?? '—';
    bigC.textContent = committee ? `اللجنة ${committee}` : 'اللجنة —';
  }
  function playTone(g){
    try{
      if(g==='MEN' && audMen) audMen.play();
      if(g==='WOMEN' && audWom) audWom.play();
    }catch(_){}
  }

  // الحدث القياسي الجديد
  socket.on('exam:called', ({gender, student, committee})=>{
    const g = normGender(gender);
    showCenter(student, committee);
    const code = `${g==='MEN' ? 'A' : 'C'}${String(student).padStart(3,'0')}`;
    if(g==='MEN') pushItem(men, code); else pushItem(wom, code);
    playTone(g);
  });

  // توافقية لو كان هناك عميل يرسل الحدث القديم "play"
  socket.on('play', (p={})=>{
    const g = normGender(p.gender || p.g);
    const student   = parseInt(p.student ?? p.s ?? p.num, 10) || 0;
    const committee = parseInt(p.committee ?? p.c, 10) || 0;
    if(!student || !committee) return;
    showCenter(student, committee);
    const code = `${g==='MEN' ? 'A' : 'C'}${String(student).padStart(3,'0')}`;
    if(g==='MEN') pushItem(men, code); else pushItem(wom, code);
    playTone(g);
  });

  // مسح القوائم
  socket.on('exam:clear', ()=>{
    men.innerHTML=''; wom.innerHTML='';
    showCenter('—', null);
    absM.textContent=''; absM.dataset.list='';
    absW.textContent=''; absW.dataset.list='';
    note.textContent='';
  });

  // الغياب
  socket.on('exam:abs', ({action, gender, number})=>{
    const g = normGender(gender);
    const el = (g==='MEN') ? absM : absW;
    const set = new Set((el.dataset.list||'').split(',').filter(Boolean));
    if(action==='add') set.add(String(number)); else set.delete(String(number));
    el.dataset.list = Array.from(set).join(',');
    el.textContent  = Array.from(set).join('  •  ');
  });

  // الملاحظة
  socket.on('exam:note', ({text})=>{
    note.textContent = text || '';
  });

  // لوج أي حدث (يساعدنا في التشخيص)
  socket.onAny((ev, ...args)=>{ console.log('[DISPLAY EVENT]', ev, ...args); });

})();
</script>
</body>
</html>
