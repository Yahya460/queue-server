<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>شاشة العرض</title>
<style>
:root{
  --bg:#eaf2fb; --panel:#fff; --bar:#0b5ed7; --accent:#e11; --text:#111;
  --muted:#6c757d; --shadow:0 6px 20px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:var(--text)}
.top{background:var(--bar);color:#fff;text-align:center;padding:8px 10px;font-weight:700}
.container{display:grid;grid-template-columns:280px 1fr 280px;gap:20px;max-width:1200px;margin:18px auto;padding:0 12px}
.panel{background:var(--panel);border-radius:10px;box-shadow:var(--shadow);overflow:hidden}
.panel h3{margin:0;padding:14px 14px;background:#f7f7f7;border-bottom:1px solid #eee;font-size:16px}
.list{padding:10px;display:flex;flex-direction:column;gap:10px}
.row{display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;border-radius:8px;padding:10px 12px;background:#fff}
.row small{color:var(--muted)}
.row .num{font-weight:800;color:var(--bar)}
.center{background:#fff;border-radius:10px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center}
.center .tit{width:100%;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #eee;color:#333}
.big{font-size:120px;font-weight:900;letter-spacing:4px;margin:40px 0 0}
.line{width:150px;height:10px;border-radius:6px;background:var(--accent);margin:28px auto}
.committee{font-size:36px;font-weight:800;margin:10px auto}
.gender{font-size:18px;color:var(--accent)}
.notice{margin:18px auto 0;width:100%;background:#fff3cd;border:1px solid #ffe69c;border-radius:8px;padding:10px;text-align:center;position:relative;overflow:hidden}
.marquee{display:inline-block;white-space:nowrap;animation:mar 15s linear infinite}
@keyframes mar{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.badge{display:inline-block;background:#d1e7dd;color:#0a3622;border:1px solid #a3cfbb;border-radius:999px;padding:1px 10px;font-weight:700}
.off{position:fixed;left:10px;bottom:10px;background:#198754;color:#fff;border-radius:6px;padding:6px 10px;font-size:12px}
</style>
</head>
<body>
<div class="top">شاشة العرض — يُرجى تفعيل الصوت بنقرة واحدة داخل الصفحة</div>

<div class="container">
  <div class="panel">
    <h3>تم النداء — نساء / WOMEN</h3>
    <div id="listW" class="list"></div>
  </div>

  <div class="center panel">
    <div class="tit">
      <span>يرجى التوجه لمنطقة الاختبار</span>
      <span class="badge">Please proceed to the examination area</span>
    </div>
    <div class="line"></div>
    <div id="big" class="big">—</div>
    <div class="committee">— اللجنة —</div>
    <div id="gen" class="gender">—</div>

    <div class="notice">
      <span id="absText">الغياب برجال: لا يوجد — الغياب بنساء: لا يوجد</span>
      <span id="noteText" class="marquee"></span>
    </div>
  </div>

  <div class="panel">
    <h3>تم النداء — رجال / MEN</h3>
    <div id="listM" class="list"></div>
  </div>
</div>

<div class="off" id="status">متصل بالخادم</div>

<audio id="audMen"   preload="none" src="men.mp3"></audio>
<audio id="audWomen" preload="none" src="women.mp3"></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
const $  = s => document.querySelector(s);
const mk = (t,cls='') => { const e=document.createElement(t); if(cls)e.className=cls; return e };

let men=[], women=[];
const socket = io();

// Unlock audio by click once
document.body.addEventListener('click', ()=>{ $('#audMen').play().catch(()=>{}); $('#audWomen').play().catch(()=>{}); }, {once:true});

function renderLists(){
  const lw = $('#listW'), lm = $('#listM');
  lw.innerHTML = ''; lm.innerHTML = '';
  women.slice().reverse().forEach(x=>{
    const r=mk('div','row');
    r.innerHTML = `<small>اللجنة ${x.committee} · نساء</small><div class="num">${x.ticket}</div>`;
    lw.appendChild(r);
  });
  men.slice().reverse().forEach(x=>{
    const r=mk('div','row');
    r.innerHTML = `<small>اللجنة ${x.committee} · رجال</small><div class="num">${x.ticket}</div>`;
    lm.appendChild(r);
  });
}

function showCenter({ticket, committee, gender}){
  $('#big').textContent = ticket || '—';
  $('.committee').textContent = committee ? `اللجنة ${committee}` : '— اللجنة —';
  $('#gen').textContent = (gender==='MEN') ? 'رجال' : (gender==='WOMEN' ? 'نساء' : '—');
}

function renderAbs(data){
  const men = (data?.MEN || []);
  const women = (data?.WOMEN || []);
  const a = men.length   ? men.join(' , ')   : 'لا يوجد';
  const b = women.length ? women.join(' , ') : 'لا يوجد';
  $('#absText').textContent = `الغياب برجال: ${a} — الغياب بنساء: ${b}`;
}

function renderNote(t){
  $('#noteText').textContent = (t && t.trim()) ? ` — ${t.trim()} — ` : '';
}

// ===== sockets =====
socket.on('connect', ()=> $('#status').textContent='متصل بالخادم');
socket.on('disconnect', ()=> $('#status').textContent='غير متصل');

socket.on('display:init', ({men:m, women:w, note, abs})=>{
  men = m || []; women=w || [];
  renderLists(); renderNote(note); renderAbs(abs);
});

socket.on('display:call', (p)=>{
  if(p.gender==='MEN'){ men.push(p); if(men.length>12) men.shift(); $('#audMen').currentTime=0; $('#audMen').play().catch(()=>{}); }
  else { women.push(p); if(women.length>12) women.shift(); $('#audWomen').currentTime=0; $('#audWomen').play().catch(()=>{}); }
  renderLists(); showCenter(p);
});

socket.on('display:clear', ()=> showCenter({ticket:'—'}));
socket.on('note:update', renderNote);
socket.on('abs:update',  renderAbs);
</script>
</body>
</html>
