<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>شاشة العرض — نظام الدور</title>
<style>
:root{
  --sky:#e5f3ff;
  --bar:#0b5ed7;
  --yellow:#f9e79f;
  --accent:#b91c1c; /* أحمر */
  --panel:#ffffff;
  --ink:#111;
  --muted:#666;
  --line:#d7e6f7;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:var(--sky);
  color:var(--ink);
}

/* شريط علوي */
.topbar{
  background:var(--bar);
  color:#fff;
  text-align:center;
  padding:.6rem .8rem;
  font-weight:600;
  position:sticky;top:0;z-index:3;
}
.topbar small{font-weight:400;opacity:.9}

/* تخطيط 3 أعمدة */
.container{
  display:grid;
  grid-template-columns: 260px 1fr 260px;
  gap:14px;
  padding:14px;
  max-width:1200px;
  margin:auto;
}
@media(max-width:1000px){
  .container{grid-template-columns: 1fr; }
}

/* لوح جانبي */
.side{
  background:#fff;
  border:1px solid var(--line);
  border-radius:10px;
  overflow:hidden;
  display:flex;flex-direction:column;
  min-height:540px;
}
.side h3{
  margin:0;
  padding:10px 12px;
  background:#fff;
  border-bottom:1px solid var(--line);
  font-size:18px;
}
.list{
  flex:1; padding:10px; overflow:auto;
}
.item{
  display:flex; justify-content:space-between; align-items:center;
  padding:8px 10px; margin-bottom:6px;
  border:1px solid var(--line); border-radius:6px; background:#fff;
  font-weight:600;
}
.item .code{font-weight:800; font-size:18px}
.item .meta{color:var(--muted); font-size:13px}

/* اللوح الأوسط */
.center{
  background:#fff;border:1px solid var(--line);
  border-radius:10px; overflow:hidden; min-height:540px;
  display:flex; flex-direction:column; align-items:center;
}
.center .head{
  width:100%; padding:12px 16px; border-bottom:1px solid var(--line);
  display:flex; justify-content:space-between; align-items:center;
}
.statusDot{position:fixed;left:10px;bottom:10px;background:#444;color:#fff;
  padding:6px 10px;border-radius:6px;font-size:12px;opacity:.9}

/* الرسالة والرقم الكبير */
.msg{
  padding:12px 16px; width:100%;
  display:flex; justify-content:space-between; align-items:flex-start;
  color:#111; font-weight:700;
}
.msg .en{font-weight:600}

.big{
  margin-top:10px; text-align:center; flex:1;
  width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;
}
.barRed{width:160px;height:10px;background:var(--accent);border-radius:6px;margin:10px auto 16px}
#bigNum{font-size:120px; font-weight:900; letter-spacing:2px; line-height:1}
.center h1{margin:0 0 6px 0; font-size:34px}
.gLabel{color:var(--accent); font-weight:800; margin-top:4px}

/* الغياب والملاحظة */
.band{
  width:100%; background:#fff4cc; border-top:1px solid var(--line);
  padding:8px 12px; text-align:center; font-weight:700;
}
.marquee{
  width:100%; overflow:hidden; white-space:nowrap; border-top:1px solid var(--line);
  background:#fff; padding:8px 0;
}
.marquee > div{
  display:inline-block; padding-right:100%;
  animation:scroll 18s linear infinite;
}
@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-100%)}
}

/* ألوان عناوين القوائم */
.tagMen{color:#0a7}
.tagWom{color:#a06}
</style>
</head>
<body>

<div class="topbar">
  شاشة العرض <b>(PLUS)</b> — يُرجى تفعيل الصوت بنقرة واحدة داخل الصفحة <small>— ثم إبقاء الصفحة مفتوحة</small>
</div>

<div class="container">

  <!-- قائمة رجال -->
  <div class="side">
    <h3> MEN / رجال — <span class="tagMen">تم النداء</span> </h3>
    <div id="menList" class="list"></div>
  </div>

  <!-- اللوح الأوسط -->
  <div class="center" id="page">
    <div class="head">
      <div class="ar">يرجى التوجه لمنطقة الاختبار</div>
      <div class="en">Please proceed to the examination area</div>
    </div>

    <div class="big">
      <div class="barRed"></div>
      <div id="bigNum">—</div>
      <h1>— اللجنة —</h1>
      <div id="gLabel" class="gLabel">—</div>
    </div>

    <div class="band" id="absBand">
      الغياب بـرجال: لا يوجد — الغياب نساء: لا يوجد
    </div>

    <div class="marquee">
      <div id="noteTicker">لا توجد ملاحظات…</div>
    </div>
  </div>

  <!-- قائمة نساء -->
  <div class="side">
    <h3> WOMEN / نساء — <span class="tagWom">تم النداء</span> </h3>
    <div id="womList" class="list"></div>
  </div>

</div>

<div id="conn" class="statusDot">متصل بالخادم</div>

<!-- أصوات -->
<audio id="audMen"></audio>
<audio id="audWom"></audio>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  const $ = s=>document.querySelector(s);
  const pad = n => String(n).padStart(3,'0');

  const menList = $('#menList');
  const womList = $('#womList');
  const bigNum = $('#bigNum');
  const gLabel = $('#gLabel');
  const absBand = $('#absBand');
  const noteTicker = $('#noteTicker');
  const conn = $('#conn');

  // قوائم العرض (آخر 12 نداء)
  const lastMen = [];
  const lastWom = [];
  const MAX = 12;

  // الغياب
  let absMen = [];
  let absWom = [];

  // الأصوات: إن وُجدت ملفات، ضع المسارات هنا:
  // $('#audMen').src = '/sounds/men.mp3';
  // $('#audWom').src = '/sounds/women.mp3';

  // بديل صوتي بسيط عند عدم وجود ملفات
  function toneShort(freq=880){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value=freq;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
      o.start(); o.stop(ctx.currentTime + 0.36);
    }catch(e){}
  }
  function playMen(){ const a=$('#audMen'); if(a.src) { a.currentTime=0; a.play().catch(()=>{}); } else { toneShort(700); } }
  function playWom(){ const a=$('#audWom'); if(a.src) { a.currentTime=0; a.play().catch(()=>{}); } else { toneShort(950); } }

  function renderLists(){
    menList.innerHTML = lastMen.map(x=>(
      `<div class="item"><span class="code">${x.code}</span><span class="meta">رجال · اللجنة ${x.c}</span></div>`
    )).join('');
    womList.innerHTML = lastWom.map(x=>(
      `<div class="item"><span class="code">${x.code}</span><span class="meta">نساء · اللجنة ${x.c}</span></div>`
    )).join('');
  }

  function renderAbs(){
    const m = absMen.length ? absMen.join('، ') : 'لا يوجد';
    const w = absWom.length ? absWom.join('، ') : 'لا يوجد';
    absBand.textContent = `الغياب بـرجال: ${m} — الغياب نساء: ${w}`;
  }

  // سوكِت
  const socket = io();

  socket.on('connect', ()=>{ conn.textContent='متصل بالخادم'; conn.style.background='#2e7d32'; });
  socket.on('disconnect', ()=>{ conn.textContent='انقطع الاتصال'; conn.style.background='#c62828'; });

  // حدث النداء من السيرفر
  socket.on('exam:called', (p)=>{
    // p = { gender:'MEN'|'WOMEN', student:number, committee:number }
    const isMen = (String(p.gender||'').toUpperCase() === 'MEN');
    const prefix = isMen ? 'A' : 'C';
    const code = `${prefix}${pad(p.student||0)}`;
    bigNum.textContent = code;
    gLabel.textContent = isMen ? 'رجال' : 'نساء';

    // حدّث القوائم
    const entry = { code, c: p.committee||'-' };
    if(isMen){
      lastMen.unshift(entry);
      if(lastMen.length>MAX) lastMen.pop();
      playMen();
    } else {
      lastWom.unshift(entry);
      if(lastWom.length>MAX) lastWom.pop();
      playWom();
    }
    renderLists();
  });

  // مسح الرقم الكبير (لا نمسح القوائم)
  socket.on('exam:clear', ()=>{
    bigNum.textContent = '—';
    gLabel.textContent = '—';
  });

  // ملاحظة
  socket.on('exam:note', (p)=>{
    const t = (p && p.text || '').trim();
    noteTicker.textContent = t ? t : '—';
  });

  // الغياب
  socket.on('exam:abs:add', (p)=>{
    const g = (p.gender||'').toUpperCase();
    const num = String(p.number||'').trim();
    if(!num) return;
    if(g==='MEN'){ if(!absMen.includes(num)) absMen.push(num); }
    else if(g==='WOMEN'){ if(!absWom.includes(num)) absWom.push(num); }
    renderAbs();
  });

  socket.on('exam:abs:remove', (p)=>{
    const g = (p.gender||'').toUpperCase();
    const num = String(p.number||'').trim();
    if(g==='MEN'){ absMen = absMen.filter(x=>x!==num); }
    else if(g==='WOMEN'){ absWom = absWom.filter(x=>x!==num); }
    renderAbs();
  });

  // للتأكد من وصول الأحداث يمكنك فتح Console وسترى التالي:
  socket.onAny((ev, ...a)=>{ /* console.log('[DISPLAY EV]', ev, ...a); */ });

  // نقرة لتفعيل الصوت في بعض المتصفحات
  document.addEventListener('click', ()=>{ try{ playMen(); }catch(e){} }, {once:true});

})();
</script>
</body>
</html>
